(ns eshygyn.tg.commands
  (:require [telegrambot-lib.core :as tg]
            
            [eshygyn.tg.new-expense :as new-expense]
            [eshygyn.db.db :as db]))

(defn start [bot chat-id]
  (tg/send-message bot chat-id "–ü—Ä–∏–≤–µ—Ç! üëã –Ø —Ç–≤–æ–π Expense Tracker –±–æ—Ç. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."))

(defn authorize [bot chat-id first-name username]
  (try
    (if (db/is-authorized chat-id)
      (tg/send-message bot chat-id "‚ÑπÔ∏è –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!\n–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚úÖ\n\n–í—ã –º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ:\n‚Ä¢ üìä –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å—Ö–æ–¥—ã ‚Äî /stats\n‚Ä¢ ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é ‚Äî /add\n‚Ä¢ ‚öôÔ∏è –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ ‚Äî /logout" {:reply_markup {:remove_keyboard true}})
      
      (do
        (db/create-user chat-id first-name username)
        (tg/send-message bot chat-id (str "‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å!\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " first-name "\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:\n‚Ä¢ üìä –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã\n‚Ä¢ ‚ûï –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n‚Ä¢ üìÖ –°–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–Ω—è–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n\n–í–≤–µ–¥–∏—Ç–µ /help, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã."))))
    
    (catch Exception e
      (println (str "\033[91mERROR\033[0m " "Caught a exception while creating user: " (.getMessage e)))
      (tg/send-message bot chat-id "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.\n\n‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.\n‚Ä¢ –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏."))))

(defn cancel [bot chat-id]
  (new-expense/clear-session! chat-id)
  (tg/send-message bot chat-id "‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ."))